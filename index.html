<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stargazer Workspace</title>
    <style>
        :root { --primary: #007AFF; --glass: rgba(255, 255, 255, 0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; color: white; height: 100vh; overflow: hidden;
            font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column;
        }

        /* Fundo de Estrelas */
        .stars-bg { position: fixed; width: 100%; height: 100%; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: fall linear infinite; }
        @keyframes fall { from { transform: translateY(-10vh); } to { transform: translateY(110vh); } }

        /* Header */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        #exportTrigger { background: var(--primary); border: none; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* Area de VisualizaÃ§Ã£o */
        .viewport { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; position: relative; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 8px; box-shadow: 0 0 40px rgba(0,122,255,0.15); }

        /* Painel de ResoluÃ§Ã£o (Aparece ao clicar em Exportar) */
        .res-panel {
            position: fixed; top: -100px; left: 0; width: 100%; background: rgba(10,10,10,0.9);
            backdrop-filter: blur(20px); padding: 20px; transition: 0.4s; z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center;
        }
        .res-panel.open { top: 0; }
        .res-track { width: 80%; height: 2px; background: #333; display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .res-node { width: 15px; height: 15px; background: #555; border-radius: 50%; cursor: pointer; position: relative; }
        .res-node.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .res-node span { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #888; }
        .res-node.active span { color: white; }

        /* Bottom Nav & Drawer */
        .bottom-nav { background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 10px 30px; }
        .tool-grid { display: flex; justify-content: space-around; }
        .tool-item { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; opacity: 0.8; }

        .drawer {
            position: fixed; bottom: -300px; left: 0; width: 100%; height: 280px;
            background: rgba(15, 15, 15, 0.98); border-radius: 25px 25px 0 0;
            transition: 0.3s; z-index: 110; padding: 20px;
        }
        .drawer.open { bottom: 0; }
        .fx-list { display: flex; gap: 15px; overflow-x: auto; margin-top: 20px; }
        .fx-item { min-width: 80px; height: 100px; background: #222; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="stars-bg" id="stars"></div>

    <div class="res-panel" id="resPanel">
        <p style="font-size: 12px; color: var(--primary)">SELECIONE A QUALIDADE DE EXPORTAÃ‡ÃƒO</p>
        <div class="res-track">
            <div class="res-node" onclick="confirmExport(0)"><span>480P</span></div>
            <div class="res-node active" onclick="confirmExport(1)"><span>720P</span></div>
            <div class="res-node" onclick="confirmExport(2)"><span>1080P</span></div>
        </div>
        <button onclick="toggleResPanel()" style="background:none; border:none; color:#555; margin-top:10px;">Cancelar</button>
    </div>

    <div class="header">
        <span onclick="window.location.href='index.html'">âœ•</span>
        <button id="exportTrigger" onclick="toggleResPanel()">EXPORTAR</button>
    </div>

    <div class="viewport">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div class="drawer" id="fxDrawer">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>EFEITOS</span>
            <span onclick="toggleFX()" style="color:var(--primary)">FECHAR</span>
        </div>
        <div class="fx-list">
            <div class="fx-item" onclick="applyFX('invert')"><span>ðŸŒ“</span><br>Inverter</div>
            <div class="fx-item" onclick="applyFX('gray')"><span>ðŸ”˜</span><br>P&B</div>
            <div class="fx-item" onclick="applyFX('reset')"><span>ðŸ”„</span><br>Reset</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="tool-grid">
            <div class="tool-item" onclick="toggleFX()">
                <span style="font-size: 24px;">âœ¨</span>
                <span>Efeitos</span>
            </div>
            <div class="tool-item">
                <span style="font-size: 24px;">ðŸŽ¨</span>
                <span>Ajustes</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const resPanel = document.getElementById('resPanel');
        let originalImg = new Image();
        
        // Carrega imagem salva no sessionStorage
        const tempImg = sessionStorage.getItem('temp_image');
        if(tempImg) {
            originalImg.src = tempImg;
            originalImg.onload = () => {
                // Inicia o canvas com o tamanho original da foto para ediÃ§Ã£o fluida
                canvas.width = originalImg.width;
                canvas.height = originalImg.height;
                ctx.drawImage(originalImg, 0, 0);
            };
        }

        function toggleResPanel() { resPanel.classList.toggle('open'); }
        function toggleFX() { document.getElementById('fxDrawer').classList.toggle('open'); }

        function applyFX(type) {
            ctx.drawImage(originalImg, 0, 0); // Sempre baseia no original
            if(type === 'reset') return;
            
            const idata = ctx.getImageData(0,0, canvas.width, canvas.height);
            const d = idata.data;
            for(let i=0; i<d.length; i+=4) {
                if(type === 'invert') { d[i]=255-d[i]; d[i+1]=255-d[i+1]; d[i+2]=255-d[i+2]; }
                if(type === 'gray') { let v=(d[i]+d[i+1]+d[i+2])/3; d[i]=d[i+1]=d[i+2]=v; }
            }
            ctx.putImageData(idata, 0, 0);
        }

        function confirmExport(resIndex) {
            const res = [{w:854,h:480}, {w:1280,h:720}, {w:1920,h:1080}][resIndex];
            
            // Criamos um canvas temporÃ¡rio sÃ³ para o redimensionamento final
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = res.w;
            tempCanvas.height = res.h;
            const tCtx = tempCanvas.getContext('2d');
            
            // Desenha o que estÃ¡ no canvas de ediÃ§Ã£o para o canvas de exportaÃ§Ã£o
            tCtx.drawImage(canvas, 0, 0, res.w, res.h);
            
            const link = document.createElement('a');
            link.download = `stargazer_export.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
            toggleResPanel();
        }

        // Estrelas
        const sCont = document.getElementById('stars');
        for(let i=0; i<30; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.width = s.style.height = Math.random()*2+'px';
            s.style.left = Math.random()*100+'%';
            s.style.animationDuration = (Math.random()*3+2)+'s';
            sCont.appendChild(s);
        }
    </script>
</body>
</html>
